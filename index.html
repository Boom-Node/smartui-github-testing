<html>

<head>
    <style>
        body {
            background: #f1f1f1;
        }
        .lens-section {
            display: flex;
            margin: 15px;
        }

        .lens-section label {
            align-items: center;
            display: inline-flex;
            width: 30%;
            margin-right: 10px;
        }

        .lens-section select {
            padding: 5px 10px;
            width: 30%;
        }

        .lens-add-ips {
            margin: 20px;
            display: flex;
        }

        .lens-add-ips input {
            padding: 5px;
            width: 50%;
            margin-right: 20px;
        }
        .hidden {
            display: none;
        }

        h1 {
            display: flex;
            justify-content: center;
            margin: 20px;
        }

        .lens-no-ips {
            border: 1px solid #a7a4a4;
            font-size: 20px;
            font-weight: bold;
            margin-top: 30px;
            padding: 20px;
        }

        #lens-loading {
            font-style: italic;
            padding: 20px;
        }

        .lens-total-vms-count {
            display: flex;
            font-size: 20px;
            font-weight: bold;
            margin-left: 15px;
            margin-top: 10px;
        }
    </style>
    <script src="jquery-min.js"></script>
</head>

<body style="text-align: -webkit-center; margin:0px;">
    <div>
    <h1>IPs Portal</h1>
    <div class="lens-section">
        <label for="settings">Choose one to continue:</label>
        <select name="settings" id="settings" onchange="toggleIpView()">
            <option value="Choose">Choose</option>
            <option value="ips-container">Enter IPs</option>
            <option value="configure-container">Customise Data</option>
        </select>
    </div>
    <div class="lens-add-ips ips-container hidden">
        <input id="ip-input" type="text" placeholder="Enter comma separated IPs here" />
        <button class="ipSubmitBtn">Submit</button>
    </div>
    <div class="configure-container hidden">
        <div class="lens-section">
            <label for="product">Product:</label>
            <select name="product" id="product" onchange="toggleProductInfo()">
                <option value="falcon">Falcon</option>
                <option value="ml">MagicLeap</option>
            </select>
        </div>
        <div class="lens-section">
            <label for="environment">Environment:</label>
            <select name="environment" id="environment">
                <option value="stage">Stage</option>
                <option value="preprod">Preprod</option>
                <option value="prod">prod</option>
            </select>
        </div>
        <div class="lens-section">
            <label for="test_running">Test Running</label>
            <input id="test_running" name="test_running" type="checkbox" />
        </div>
        <div class="lens-falcon-section">
            <div class="lens-section">
                <label for="templates">Templates:</label>
                <select name="templates" id="templates">
                    <option value="Temp_Ubuntu_Emulator_Docker_18.04_ALL">Temp_Ubuntu_Emulator_Docker_18.04_ALL</option>
                    <option value="Temp_Mac_10.14_ALL">Temp_Mac_10.14_ALL</option>
                    <option value="Temp_Mac_10.15_ALL">Temp_Mac_10.15_ALL</option>
                    <option value="monterey">monterey</option>
                    <option value="bigsur-safari-15">bigsur-safari-15</option>
                    <option value="bigsur">bigsur</option>
                    <option value="Temp_Simulator_10.14_ALL">Temp_Simulator_10.14_ALL</option>
                    <option value="catalina-safari-14">catalina-safari-14</option>
                    <option value="Temp_Simulator_10.12_ALL">Temp_Simulator_10.12_ALL</option>
                    <option value="Temp_Mac_10.12_ALL">Temp_Mac_10.12_ALL</option>
                    <option value="Temp_Mac_10.13_ALL">Temp_Mac_10.13_ALL</option>
                    <option value="Temp_Mac_10.10_ALL">Temp_Mac_10.10_ALL</option>
                    <option value="Temp_Mac_10.11_SA_11">Temp_Mac_10.11_SA_11</option>
                    <option value="Temp_Mac_10.9_ALL">Temp_Mac_10.9_ALL</option>
                    <option value="Temp_Mac_10.11_ALL">Temp_Mac_10.11_ALL</option>
                    <option value="Temp_Win_10_IE_11_ALL">Temp_Win_10_IE_11_ALL</option>
                    <option value="windows-11">windows-11</option>
                    <option value="Temp_Mac_11.0_ALL_SCR">Temp_Mac_11.0_ALL_SCR</option>
                    <option value="Temp_Mac_10.11_ALL_SCR">Temp_Mac_10.11_ALL_SCR</option>
                    <option value="Temp_Mac_10.15_ALL_SCR">Temp_Mac_10.15_ALL_SCR</option>
                    <option value="Temp_Mac_10.10_ALL_SCR">Temp_Mac_10.10_ALL_SCR</option>
                    <option value="Temp_Mac_10.13_ALL_SCR">Temp_Mac_10.13_ALL_SCR</option>
                    <option value="Temp_Mac_10.12_ALL_SCR">Temp_Mac_10.12_ALL_SCR</option>
                    <option value="Temp_Mac_10.8_ALL_SCR">Temp_Mac_10.8_ALL_SCR</option>
                    <option value="Temp_Mac_10.14_ALL_SCR">Temp_Mac_10.14_ALL_SCR</option>
                    <option value="Temp_Mac_10.7_ALL_SCR">Temp_Mac_10.7_ALL_SCR</option>
                    <option value="Temp_Mac_10.7_ALL">Temp_Mac_10.7_ALL"</option>
                    <option value="Temp_Mac_10.8_ALL">Temp_Mac_10.8_ALL</option>
                    <option value="Temp_Win_7_IE_9_ALL">Temp_Win_7_IE_9_ALL</option>
                    <option value="Temp_Win_7_IE_10_ALL">Temp_Win_7_IE_10_ALL</option>
                    <option value="Temp_Win_8.1_IE_11_ALL_SCR">Temp_Win_8.1_IE_11_ALL_SCR</option>
                    <option value="Temp_Win_10_ED_18_ALL">Temp_Win_10_ED_18_ALL</option>
                    <option value="Temp_Win_8_IE_10_ALL_SCR">Temp_Win_8_IE_10_ALL_SCR</option>
                    <option value="Temp_Win_7_IE_11_ALL_SCR">Temp_Win_7_IE_11_ALL_SCR</option>
                    <option value="Temp_Win_10_IE_11_ALL_SCR">Temp_Win_10_IE_11_ALL_SCR</option>
                    <option value="windows-11-scr">windows-11-scr</option>
                    <option value="Temp_Win_10_ED_18_ALL_SCR">Temp_Win_10_ED_18_ALL_SCR</option>
                    <option value="Temp_Win_7_IE_8_ALL">Temp_Win_7_IE_8_ALL</option>
                    <option value="Temp_Win_7_IE_10_ALL_SCR">Temp_Win_7_IE_10_ALL_SCR</option>
                    <option value="Temp_Win_XP_IE_7_ALL">Temp_Win_XP_IE_7_ALL</option>
                    <option value="Temp_Win_10_ED_15_ALL_SCR">Temp_Win_10_ED_15_ALL_SCR</option>
                    <option value="Temp_Win_7_IE_9_ALL_SCR">Temp_Win_7_IE_9_ALL_SCR</option>
                    <option value="Temp_Win_10_ED_17_ALL_SCR">Temp_Win_10_ED_17_ALL_SCR</option>
                    <option value="Temp_Win_7_IE_8_ALL_SCR">Temp_Win_7_IE_8_ALL_SCR</option>
                    <option value="Temp_Win_10_ED_16_ALL_SCR">Temp_Win_10_ED_16_ALL_SCR</option>
                    <option value="Temp_Win_10_ED_17_ALL">Temp_Win_10_ED_17_ALL</option>
                    <option value="Temp_Win_10_ED_15_ALL">Temp_Win_10_ED_15_ALL</option>
                    <option value="Temp_Win_XP_IE_8_ALL">Temp_Win_XP_IE_8_ALL</option>
                    <option value="Temp_Win_10_ED_16_ALL">Temp_Win_10_ED_16_ALL</option>
                    <option value="Temp_Win_8.1_IE_11_ALL">Temp_Win_8.1_IE_11_ALL</option>
                    <option value="Temp_Win_7_IE_11_ALL">Temp_Win_7_IE_11_ALL</option>
                    <option value="Temp_Win_8_IE_10_ALL">Temp_Win_8_IE_10_ALL</option>
                </select>
            </div>
            <div class="lens-section">
                <label for="region">Region:</label>
                <select name="region" id="region">
                    <option value="us-east-1">US East 1</option>
                    <option value="eu-central-1">EU Central 1</option>
                    <option value="us">US</option>
                    <option value="eu">EU</option>
                </select>
            </div>
            <div class="lens-section">
                <label for="provider">Provider:</label>
                <select name="provider" id="provider">
                    <option value="MS">MS</option>
                    <option value="LW">LW</option>
                    <option value="HZ">HZ</option>
                    <option value="LW-US">LW-US</option>
                    <option value="LW-UK">LW-UK</option>
                    <option value="GM">GM</option>
                    <option value="AWS">AWS</option>
                </select>
            </div>
        </div>
        <div class="lens-ml-section hidden">
            <div class="lens-section">
                <label for="ml_templates">Templates</label>
                <select name="ml_templates" id="ml_templates">
                    <option value="windows-7-ie-8">windows-7-ie-8</option>
                    <option value="windows-7-ie-9">
                        windows-7-ie-9 </option>
                    <option value="windows-7-ie-10">
                        windows-7-ie-10 </option>
                    <option value="windows-7">windows-7</option>
                    <option value="windows-8">windows-8</option>
                    <option value="windows-8.1">windows-8.1</option>
                    <option value="windows-10">windows-10</option>
                    <option value="windows-10-edge-15">windows-10-edge-15</option>
                    <option value="windows-10-edge-16">windows-10-edge-16</option>
                    <option value="windows-10-edge-17">windows-10-edge-17</option>
                    <option value="windows-10-edge-18">windows-10-edge-18</option>
                    <option value="windows-11">windows-11</option>
                    <option value="macos-big-sur">macos-big-sur</option>
                    <option value="macos-catalina">macos-catalina</option>
                    <option value="macos-high-sierra">macos-high-sierra</option>
                    <option value="macos-mojave">macos-mojave</option>
                    <option value="macos-monterey">macos-monterey</option>
                    <option value="macos-sierra">macos-sierra</option>
                    <option value="os-x-el-capitan">os-x-el-capitan</option>
                    <option value="os-x-mavericks">os-x-mavericks</option>
                    <option value="os-x-yosemite">os-x-yosemite</option>
                </select>
            </div>
            <div class="lens-section">
                <label for="ml_provider">Provider</label>
                <select name="ml_provider" id="ml_provider">
                    <option value="UL">UL</option>
                    <option value="LW">LW</option>
                    <option value="LW-UK">LW-UK </option>
                    <option value="MS">MS</option>
                    
                </select>
            </div>
            <div class="lens-section">
                <label for="ml_region">Region</label>
                <select name="ml_region" id="ml_region">
                    <option value="us-west-1">us-west-1</option>
                    <option value="us-east-1">us-east-1</option>
                    <option value="eu-west-2">eu-west-2 </option>
                    <option value="eu-west-1">eu-west-1</option>
                    <option value="us-west-2">us-west-2</option>
                    <option value="us-east-2">us-east-2</option>
                </select>
            </div>
        </div>
        <button class="submitBtn">Submit</button>
        <div id="lens-loading" class="hidden">Loading...</div>
    </div>
    <div id="container"></div>

    <script type="text/javascript">
        const ProductToClassMap = {
            'ml': 'lens-ml-section',
            'falcon': 'lens-falcon-section'
        };
        const IpViewToClassMap = {
            'ips-container': 'ips-container',
            'configure-container': 'configure-container'
        };
        var arr = [];
        const toggleProductInfo = () => {
            toggleElView('product', ProductToClassMap);
        }

        const toggleIpView = () => {
            toggleElView('settings', IpViewToClassMap);
        }

        const toggleElView = (elId, classMap) => {
            const el = document.getElementById(elId);
            const selectedValue = el.value;
            Object.values(classMap).forEach(className => {
                const el = document.getElementsByClassName(className)[0];
                el.classList.add('hidden');
            })
            const sectionClassToShow = classMap[selectedValue];
            const sectionEl = document.getElementsByClassName(sectionClassToShow)[0];
            sectionEl.classList.remove('hidden');
        }

        const fetchFalconData = () => {
            const queryParams = getQueryParams({
                templateElId: 'templates', 
                regionElId: 'region', 
                envElId: 'environment', 
                testRunningElId: 'test_running', 
                providerElId: 'provider',
                testRunningParamName: 'session_ind',
            });
            const selectedEnvironment = document.getElementById('environment').value;
            let apiEndpoint = 'https://manual-api.lambdatest.com';
            if (selectedEnvironment === 'stage') {
                apiEndpoint = 'https://stage-app-api.lambdatest.com';
            }
            sendXhrRequest({ url: `${apiEndpoint}/lvms/vm`, queryParams, selectedProduct: 'falcon' })
        }

        const fetchMlData = () => {
            const queryParams = getQueryParams({
                templateElId: 'ml_templates',
                regionElId: 'ml_region',
                envElId: 'environment',
                testRunningElId: 'test_running',
                providerElId: 'ml_provider',
            });
            sendXhrRequest({ url: 'https://i4m17woe8a.execute-api.us-east-1.amazonaws.com/prod/vm/pool', queryParams, selectedProduct: 'ml' })

        }

        const sendXhrRequest = ({ url, queryParams, selectedProduct }) => {
            document.getElementById('lens-loading').classList.remove('hidden');
            removeChildren();
            fetch(`${url}${queryParams}`, {
                headers: new Headers({
                    'Content-Type': 'application/json'
                })
            })
            .then(response => {
                return response.json();
            })
            .then(jsonArr => {
                document.getElementById('lens-loading').classList.add('hidden');
                getIps(jsonArr, selectedProduct);
                const ips = getIps(jsonArr, selectedProduct);
                if (ips.length > 0) {
                    bindVms(ips);
                } else { 
                    const div = document.createElement('div');
                    div.classList.add('lens-no-ips');
                    div.innerText = 'Sorry, no IPs found';
                    document.getElementById('container').appendChild(div);
                }
            })
        }

        const getIps = (response, selectedProduct) => {
            if (selectedProduct === 'ml') {
                return response.map(({ ip }) => ip);
            } else {
                const { vms = []} = response;
                return vms.map(({ ipv4 }) => ipv4);
            }
        }

        const removeChildren = () => {
            // Remove previous VMs
            const containerEl = document.getElementById("container");
            while (containerEl.hasChildNodes()) {
                containerEl.removeChild(containerEl.firstChild);
            }
        }

        const getQueryParams = ({ templateElId, regionElId, envElId, testRunningParamName = 'testRunning', testRunningElId, providerElId }) => {
            const selectedTemplates = document.getElementById(templateElId).value;
            const selectedRegion = document.getElementById(regionElId).value;
            const selectedEnvironment = document.getElementById(envElId).value;
            const testRunning = +document.getElementById(testRunningElId).checked;
            const provider = document.getElementById(providerElId).value;
            return `?templateId=${selectedTemplates}&region=${selectedRegion}&env=${selectedEnvironment}&${testRunningParamName}=${testRunning}&provider=${provider}`;
        }

        const submitBtn = document.getElementsByClassName('submitBtn')[0];
        submitBtn.addEventListener('click', function (event) {
            const selectedProduct = document.getElementById('product').value;
            if (selectedProduct === 'falcon') {
                fetchFalconData();
            } else {
                fetchMlData();
            }
        });

        const ipSubmitBtn =  document.getElementsByClassName('ipSubmitBtn')[0];
        ipSubmitBtn.addEventListener('click', () => {
            const ips = document.getElementById('ip-input').value;
            arr = ips.split(',')
            document.getElementById('ip-input').value = "";
            bindVms(arr);
        });

        // arr = ["10.92.181.126","10.92.181.127","10.92.181.128","10.92.181.129","10.92.181.130","10.92.181.131","10.92.181.132","10.92.181.133","10.92.181.134","10.92.181.135","10.92.181.136","10.92.181.137","10.92.181.138","10.92.181.139","10.92.181.140","10.92.181.120","10.92.181.121","10.92.181.124","10.92.181.115","10.92.181.119"];

        //MOjave
        // const arr = ["10.52.0.10","10.52.0.11","10.52.0.12","10.52.0.13","10.52.0.14","10.52.0.15","10.52.0.16","10.52.0.17","10.52.0.18","10.52.0.19","10.52.0.20","10.52.0.21","10.52.0.22","10.52.0.3","10.52.0.4","10.52.0.5","10.52.0.6","10.52.0.7","10.52.0.8","10.52.0.9","10.92.181.111","10.92.181.112","10.92.181.113","10.92.181.114","10.92.181.116","10.92.181.117","10.92.181.118","10.92.181.122","10.92.181.125","10.92.181.161","10.92.181.162","10.92.181.164","10.92.181.168","10.92.181.169","10.92.181.171","10.92.181.172","10.92.181.173","10.92.181.174"];

        // "10.253.33.36","10.253.33.38","10.253.33.39",
        // Mojave
        var arr = ["10.244.33.151"];

        // Catalina
        // arr = ["10.253.33.12","10.253.33.13","10.253.33.14","10.253.33.15","10.253.33.16","10.253.33.17","10.253.33.18","10.253.33.19","10.253.33.2","10.253.33.20","10.253.33.21","10.253.33.22","10.253.33.23","10.253.33.24","10.253.33.25","10.253.33.27","10.253.33.28","10.253.33.29","10.253.33.3","10.253.33.30","10.253.33.31","10.253.33.32","10.253.33.33","10.253.33.34","10.253.33.35","10.253.33.36","10.253.33.38","10.253.33.39","10.253.33.40","10.253.33.41","10.253.33.42","10.253.33.43","10.253.33.44","10.253.33.45","10.253.33.46","10.253.33.47","10.253.33.48","10.253.33.49","10.253.33.5","10.253.33.50","10.253.33.51","10.253.33.59","10.253.33.7"]

        function bindVms(arr) {
            removeChildren();
            if (arr.length) {
                // Show the total count to the user
                const totalVms = document.createElement('div');
                totalVms.classList.add('lens-total-vms-count');
                totalVms.innerText = `Total VMs found : ${arr.length}`;
                document.getElementById("container").appendChild(totalVms);
            }
            for (var i = 0; i < arr.length; i++) {
                const link = "/guacamole.html?host=" + arr[i]+"&port=5901";
                console.log(link)

                const iframe = document.createElement('iframe');
                iframe.frameBorder = 0;
                iframe.width = "250px";
                iframe.height = "200px";
                iframe.id = "iframe-" + i;
                iframe.disabled = true;
                iframe.setAttribute("src", link + '&readonly=true');

                const div = document.createElement('div');
                div.id = "div-" + i;
                div.style.margin = "22px";
                // div.style.paddingTop = "15px";
                div.style.width = "250px";
                div.style.height = "200px";
                div.style.display = "inline-block";
                div.style.float = "left";


                const anchor = document.createElement("A");
                anchor.target = "_blank";
                const ip = document.createTextNode(arr[i]);
                anchor.setAttribute("href", link);
                anchor.appendChild(ip);
                anchor.style.display = "inline-block";
                anchor.style.position = "relative";
                anchor.style.zIndex = "1";
                anchor.style.padding = "1em";


                const refresh = document.createElement("Button");
                refresh.innerText = "Refresh";
                refresh.style.marginLeft = "10px";
                refresh.onclick = function() {
                    iframe.src = iframe.src;
                }

                document.getElementById("container").appendChild(div);
                document.getElementById("div-" + i).appendChild(iframe);
                document.getElementById("div-" + i).appendChild(anchor);
                document.getElementById("div-" + i).appendChild(refresh);
            }

        }

        bindVms(arr)
        // $.get("http://lvms.default.svc.cluster.local/api/v1/vms", function(data, status) {
        //     bindVms(arr);
        // });
    </script>
</body>

</html